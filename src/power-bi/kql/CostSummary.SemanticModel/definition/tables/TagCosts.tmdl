/// Cost summarized by resource
table TagCosts
	lineageTag: cc65080c-52f7-4964-b397-9f2c3f7ef265

	column BilledCost
		dataType: double
		lineageTag: 222fc764-2c01-479f-97eb-4f2a2d738556
		summarizeBy: sum
		sourceColumn: BilledCost

		annotation SummarizationSetBy = Automatic

		annotation PBI_FormatHint = {"isGeneralNumber":true}

	column BillingCurrency
		dataType: string
		lineageTag: 2bb0fe70-d0a2-4a5d-b91a-f2822cfad358
		summarizeBy: none
		sourceColumn: BillingCurrency

		annotation SummarizationSetBy = Automatic

	column ChargePeriodEnd
		dataType: dateTime
		formatString: General Date
		lineageTag: 2b302b2a-7b44-416d-99ec-c9c5e08ce36a
		summarizeBy: none
		sourceColumn: ChargePeriodEnd

		annotation SummarizationSetBy = Automatic

	column ChargePeriodStart
		dataType: dateTime
		formatString: General Date
		lineageTag: 7f1e9108-76f5-47ea-9c4a-7f48c7533d30
		summarizeBy: none
		sourceColumn: ChargePeriodStart

		annotation SummarizationSetBy = Automatic

	column ContractedCost
		dataType: double
		lineageTag: fe9043d7-72fe-4615-92d3-41cb3c665393
		summarizeBy: sum
		sourceColumn: ContractedCost

		annotation SummarizationSetBy = Automatic

		annotation PBI_FormatHint = {"isGeneralNumber":true}

	column EffectiveCost
		dataType: double
		lineageTag: a444d03e-a429-4d00-b45a-5c34e0d6c1f0
		summarizeBy: sum
		sourceColumn: EffectiveCost

		annotation SummarizationSetBy = Automatic

		annotation PBI_FormatHint = {"isGeneralNumber":true}

	column ListCost
		dataType: double
		lineageTag: 901cd15f-9ed5-45cc-891a-f9ca5570341e
		summarizeBy: sum
		sourceColumn: ListCost

		annotation SummarizationSetBy = Automatic

		annotation PBI_FormatHint = {"isGeneralNumber":true}

	column x_CommitmentDiscountSavings
		dataType: double
		lineageTag: 81651eba-c48f-44b1-9d81-a2c4d2b7b910
		summarizeBy: sum
		sourceColumn: x_CommitmentDiscountSavings

		annotation SummarizationSetBy = Automatic

		annotation PBI_FormatHint = {"isGeneralNumber":true}

	column x_CostCategories
		dataType: string
		lineageTag: af7cca7c-55db-4696-84ce-7fdb43641c56
		summarizeBy: none
		sourceColumn: x_CostCategories

		annotation SummarizationSetBy = Automatic

	column x_CostCenter
		dataType: string
		lineageTag: be42d94f-606e-421c-b065-9b41492c8490
		summarizeBy: none
		sourceColumn: x_CostCenter

		annotation SummarizationSetBy = Automatic

	column x_NegotiatedDiscountSavings
		dataType: double
		lineageTag: 94d392af-580f-4fc6-bb74-70360985dc71
		summarizeBy: sum
		sourceColumn: x_NegotiatedDiscountSavings

		annotation SummarizationSetBy = Automatic

		annotation PBI_FormatHint = {"isGeneralNumber":true}

	column x_ReportingDate
		dataType: dateTime
		formatString: General Date
		lineageTag: 44450f67-0f96-472d-a15b-197e66d55923
		summarizeBy: none
		sourceColumn: x_ReportingDate

		annotation SummarizationSetBy = Automatic

	column x_TotalSavings
		dataType: double
		lineageTag: eaf314b2-be0c-42de-8950-5a47b5155004
		summarizeBy: sum
		sourceColumn: x_TotalSavings

		annotation SummarizationSetBy = Automatic

		annotation PBI_FormatHint = {"isGeneralNumber":true}

	column tag_Application
		dataType: string
		lineageTag: 7d06ee18-caf1-4fc3-a167-718afc1f19a7
		summarizeBy: none
		sourceColumn: tag_Application

		annotation SummarizationSetBy = Automatic

	column tag_CostCenter
		dataType: string
		lineageTag: 86cc15a8-4ef3-4a53-bee5-207c9914e14f
		summarizeBy: none
		sourceColumn: tag_CostCenter

		annotation SummarizationSetBy = Automatic

	column tag_Department
		dataType: string
		lineageTag: 9e7397a4-8546-47ec-9a69-cbb34d71aefe
		summarizeBy: none
		sourceColumn: tag_Department

		annotation SummarizationSetBy = Automatic

	column tag_Env
		dataType: string
		lineageTag: 8c2cfb74-d3ed-4c46-bd67-be7fd725a745
		summarizeBy: none
		sourceColumn: tag_Env

		annotation SummarizationSetBy = Automatic

	column tag_Owner
		dataType: string
		lineageTag: 198220e3-3758-4437-8520-35424c5c6edd
		summarizeBy: none
		sourceColumn: tag_Owner

		annotation SummarizationSetBy = Automatic

	column tag_Project
		dataType: string
		lineageTag: 7fe263bb-c2ca-4989-8b68-7b580c955a4f
		summarizeBy: none
		sourceColumn: tag_Project

		annotation SummarizationSetBy = Automatic

	column tag_Service
		dataType: string
		lineageTag: 35efa30c-e0bc-4811-9ce6-fc385a38ffeb
		summarizeBy: none
		sourceColumn: tag_Service

		annotation SummarizationSetBy = Automatic

	column CommitmentDiscountCategory
		dataType: string
		lineageTag: ee9e68f8-6449-4d7b-addb-fe74fdd7cc2b
		summarizeBy: none
		sourceColumn: CommitmentDiscountCategory

		annotation SummarizationSetBy = Automatic

	column CommitmentDiscountId
		dataType: string
		lineageTag: 05f9fe5a-b12d-4692-b6ce-87f0a7608369
		summarizeBy: none
		sourceColumn: CommitmentDiscountId

		annotation SummarizationSetBy = Automatic

	column CommitmentDiscountName
		dataType: string
		lineageTag: dc924f77-d8ec-4f55-834a-440b08a9f25c
		summarizeBy: none
		sourceColumn: CommitmentDiscountName

		annotation SummarizationSetBy = Automatic

	column CommitmentDiscountType
		dataType: string
		lineageTag: 2183563b-f74d-4fe0-aa42-ae6553eecb5a
		summarizeBy: none
		sourceColumn: CommitmentDiscountType

		annotation SummarizationSetBy = Automatic

	column x_ChargePeriodMonth
		dataType: dateTime
		formatString: General Date
		lineageTag: 5d26fbf1-9c38-4e6e-a4be-7006dcb6d83d
		summarizeBy: none
		sourceColumn: x_ChargePeriodMonth

		annotation SummarizationSetBy = Automatic

	column tag_Untagged
		dataType: boolean
		formatString: """TRUE"";""TRUE"";""FALSE"""
		lineageTag: c35e42aa-281b-4852-9c77-e37a23ab671c
		summarizeBy: none
		sourceColumn: tag_Untagged

		annotation SummarizationSetBy = Automatic

	column tag_Product
		dataType: string
		lineageTag: 693b17fa-35c6-4aa5-b63f-0c75f5fc184c
		summarizeBy: none
		sourceColumn: tag_Product

		annotation SummarizationSetBy = Automatic

	partition TagCosts = m
		mode: import
		queryGroup: 'Data Explorer'
		source =
				let
				    lookback = Text.From(if #"Number of Months" = "" or #"Number of Months" = null then 999 else #"Number of Months"),
				    Source = AzureDataExplorer.Contents(#"Cluster URI", "Hub", "
				
				    let numberOfMonths = " & lookback & ";
				    let monthlyGranularity = " & Text.From(#"Daily or Monthly" = "Monthly") & ";
				    let allowCostManagementAllocationRules = false;
				    let summarizeAfterRowCount = 400000;
				    //
				    // Set the tags you want to promote as 'tag_*' columns in this array
				    let promotedTags = dynamic(['Application', 'BusinessUnit', 'CostCenter', 'Department', 'Division', 'Env', 'Owner', 'Product', 'Project', 'Purpose', 'Service']);
				    //
				    // This option matches tag keys that may have different case (e.g., 'env' and 'ENV')
				    let caseInsensitive = true;
				    //
				    // This option removes any unwanted spaces before or after the tag key
				    let trimSpaces = true;
				    //
				    let checktag = (key: string) {
				        let tagColumn = print tag = promotedTags | mv-expand tag | where tag == key or (caseInsensitive and tag =~ key) | project tag = strcat('tag_', tag);
				        iff(toscalar(tagColumn | count) > 0, toscalar(tagColumn | limit 1), '')
				    };
				    Costs_v1_0
				    | where ChargePeriodStart >= monthsago(numberOfMonths)
				    | where allowCostManagementAllocationRules or isempty(x_CostAllocationRuleName)
				    | extend x_ChargePeriodMonth = startofmonth(ChargePeriodStart)
				    | extend x_ReportingDate = iff(monthlyGranularity, x_ChargePeriodMonth, startofday(ChargePeriodStart))
				    //
				    | extend Tags = tostring(Tags)
				    | summarize
				        BilledCost = sum(BilledCost),
				        ChargePeriodEnd = max(ChargePeriodEnd),
				        ChargePeriodStart = min(ChargePeriodStart),
				        ContractedCost = sum(ContractedCost),
				        EffectiveCost = sum(EffectiveCost),
				        ListCost = sum(ListCost)
				        by
				            BillingCurrency,
				            CommitmentDiscountCategory,
				            CommitmentDiscountId,
				            CommitmentDiscountName,
				            CommitmentDiscountType,
				            Tags,
				            x_ChargePeriodMonth,
				            x_CostCategories = tostring(x_CostCategories),
				            x_CostCenter,
				            x_ReportingDate,
				            tag_Untagged = isempty(Tags) or Tags == '{}'
				    //
				    // Extract tags
				    | extend Tags = parse_json(Tags)
				    | mv-apply Tags on (
				        extend TagName = tostring(bag_keys(Tags)[0])
				        | extend cleanTagName = iff(trimSpaces, trim(' ', TagName), TagName)
				        | where cleanTagName in (promotedTags) or (caseInsensitive and cleanTagName in~ (promotedTags))
				        | extend tagColumn = strcat('tag_', promotedTags[array_index_of(parse_json(tolower(promotedTags)), tolower(cleanTagName))])
				        | where isnotempty(tagColumn)
				        | summarize Tags = make_bag(bag_pack(tagColumn, tostring(Tags[TagName])))
				    )
				    | extend x_CommitmentDiscountSavings = ContractedCost - EffectiveCost
				    | extend x_NegotiatedDiscountSavings = ListCost - ContractedCost
				    | extend x_TotalSavings = ListCost - EffectiveCost
				    | evaluate bag_unpack(Tags)
				    | project-reorder
				        BilledCost,
				        BillingCurrency,
				        ChargePeriodEnd,
				        ChargePeriodStart,
				        CommitmentDiscountCategory,
				        CommitmentDiscountId,
				        CommitmentDiscountName,
				        CommitmentDiscountType,
				        ContractedCost,
				        EffectiveCost,
				        ListCost,
				        x_ChargePeriodMonth,
				        x_CommitmentDiscountSavings,
				        x_CostCategories,
				        x_CostCenter,
				        x_NegotiatedDiscountSavings,
				        x_ReportingDate,
				        x_TotalSavings,
				        tag_Untagged
				
				    ", [MaxRows=null, MaxSize=1073741824, NoTruncate=false, AdditionalSetStatements=null, ClientRequestIdPrefix="ftk-CostSummary-TagCosts"])
				in
				    Source

	annotation PBI_NavigationStepName = Navigation

	annotation PBI_ResultType = Table

