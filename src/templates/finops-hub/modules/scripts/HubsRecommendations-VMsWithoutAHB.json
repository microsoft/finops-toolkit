{
    "inputDataset": "resourceGraph",
    "outputDataset": "Recommendations",
    "provider": "Microsoft",
    "query": "resourcecontainers | where type =~ 'Microsoft.Resources/subscriptions' | where tostring (properties.subscriptionPolicies.quotaId) !has 'MSDNDevTest_2014-09-01' | extend SubscriptionName=name | join (    resources     | where type =~ 'microsoft.compute/virtualmachines' or type =~ 'microsoft.compute/virtualMachineScaleSets'    | where tostring(properties.storageProfile.imageReference.publisher ) == 'MicrosoftWindowsServer' or tostring(properties.virtualMachineProfile.storageProfile.osDisk.osType) == 'Windows' or tostring(properties.storageProfile.imageReference.publisher ) == 'microsoftsqlserver'    | where tostring(properties.['licenseType']) !has 'Windows' and tostring(properties.virtualMachineProfile.['licenseType']) == 'Windows_Server'    | extend WindowsId=id, VMSku=tostring(properties.hardwareProfile.vmSize), vmResourceGroup=resourceGroup, vmType=type, Location=location,LicenseType = tostring(properties.['licenseType'])    | extend ActualCores = toint(extract('.[A-Z]([0-9]+)', 1, tostring(properties.hardwareProfile.vmSize)))    | extend CheckAHBWindows = case(        type == 'microsoft.compute/virtualmachines' or type =~ 'microsoft.compute/virtualMachineScaleSets', iif((properties.['licenseType'])        !has 'Windows' and (properties.virtualMachineProfile.['licenseType']) !has 'Windows' , 'AHB-disabled', 'AHB-enabled'),        'Not Windows'    )) on subscriptionId | project     x_RecommendationId=strcat(tolower(WindowsId),'-CheckAHBWindows'),     x_ResourceGroupName=tolower(vmResourceGroup),     SubAccountId=subscriptionId,     x_RecommendationCategory='Cost',     x_RecommendationImpact='Medium',     x_RecommendationTypeId='f326c065-b9f7-4a0e-a0f1-5a1c060bc25d',     x_RecommendationControl='RateOptimization/Licensing',     x_RecommendationMaturityLevel='Preview',     x_RecommendationDescription='Windows virtual machine is not leveraging Azure Hybrid Benefit',     x_RecommendationSolution='Review the virtual machine licensing option',     ResourceId = tolower(WindowsId),     x_ResourceType=vmType,     ResourceName=tolower(split(WindowsId,'/')[-1]),     x_RecommendationDetails= strcat('{\\\"VMSku\\\": ', VMSku, ',\\\"CheckAHBWindows\\\": \\\"', CheckAHBWindows,',\\\"ActualCores\\\": \\\"', ActualCores,',\\\"Location\\\": \\\"', Location, '\\\" }'),     x_RecommendationDate = now() | join kind=leftouter ( resourcecontainers | where type == 'microsoft.resources/subscriptions' | project SubAccountName=name, SubAccountId=subscriptionId ) on SubAccountId | project-away SubAccountId1",
    "schemaFile": "recommendations_1.0.json",
    "scope": "azurerbac",
    "source": "Azure Resource Graph",
    "type": "HubsRecommendations-VMsWithoutAHB",
    "version": "1.0"
}