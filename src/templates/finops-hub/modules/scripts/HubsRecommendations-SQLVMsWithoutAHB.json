{
    "dataset": "Recommendations",
    "provider": "Microsoft",
    "query": "resourcecontainers | where type =~ 'Microsoft.Resources/subscriptions' | where tostring (properties.subscriptionPolicies.quotaId) !has 'MSDNDevTest_2014-09-01' | extend SubscriptionName=name | join (     resources | where type =~ 'Microsoft.SqlVirtualMachine/SqlVirtualMachines' and tostring(properties.['sqlServerLicenseType']) != 'AHUB'     | extend SQLID=id, VMName = name, resourceGroup, Location = location, LicenseType = tostring(properties.['sqlServerLicenseType']), OSType=tostring(properties.storageProfile.imageReference.offer), SQLAgentType = tostring(properties.['sqlManagement']), SQLVersion = tostring(properties.['sqlImageOffer']), SQLSKU=tostring(properties.['sqlImageSku'])) on subscriptionId | join (    resources    | where type =~ 'Microsoft.Compute/virtualmachines'    | extend ActualCores = toint(extract('.[A-Z]([0-9]+)', 1, tostring(properties.hardwareProfile.vmSize)))    | project VMName = tolower(name), VMSize = tostring(properties.hardwareProfile.vmSize),ActualCores, subscriptionId, vmType=type, vmResourceGroup=resourceGroup) on VMName| order by id asc    | where SQLSKU != 'Developer' and SQLSKU != 'Express'| extend CheckAHBSQLVM= case(    type == 'Microsoft.SqlVirtualMachine/SqlVirtualMachines', iif((properties.['sqlServerLicenseType']) != 'AHUB', 'AHB-disabled', 'AHB-enabled'),    'Not Windows')| project SQLID,VMName,resourceGroup, Location, VMSize, SQLVersion, SQLSKU, SQLAgentType, LicenseType, SubscriptionName,type,CheckAHBSQLVM, subscriptionId,ActualCores, vmType, vmResourceGroup| project     x_RecommendationId=strcat(tolower(SQLID),'-CheckAHBSQLVM'),     x_ResourceGroupName=tolower(vmResourceGroup),     SubAccountId=subscriptionId,     x_RecommendationCategory='Cost',     x_RecommendationTypeId='01decd62-f91b-4434-abe5-9a09e13e018f',     x_RecommendationDescription='SQL virtual machine is not leveraging Azure Hybrid Benefit',     x_RecommendationSolution='Review the SQL licensing option',     ResourceId = tolower(SQLID),     x_ResourceType=vmType,     ResourceName=tolower(VMName),     x_RecommendationDetails= strcat('{\\\"VMSize\\\": \\\"', VMSize, '\\\", \\\"CheckAHBSQLVM\\\": \\\"', CheckAHBSQLVM, '\\\", \\\"ActualCores\\\": \\\"', ActualCores, '\\\", \\\"SQLVersion\\\": \\\"', SQLVersion, '\\\", \\\"SQLSKU\\\": \\\"', SQLSKU, '\\\", \\\"SQLAgentType\\\": \\\"', SQLAgentType, '\\\", \\\"LicenseType\\\": \\\"', LicenseType, '\\\", \\\"Location\\\": \\\"', Location, '\\\"}'),     x_RecommendationDate = now() | join kind=leftouter ( resourcecontainers | where type == 'microsoft.resources/subscriptions' | project SubAccountName=name, SubAccountId=subscriptionId ) on SubAccountId | project-away SubAccountId1",
    "queryEngine": "resourceGraph",
    "scope": "tenant",
    "source": "Azure Resource Graph",
    "type": "HubsRecommendations-SQLVMsWithoutAHB",
    "version": "1.0"
}